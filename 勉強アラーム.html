<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜1æ•°å­¦ã‚¢ãƒ©ãƒ¼ãƒ  - ãƒ‘ãƒãƒ«å…¥åŠ›ç‰ˆ</title>
    <style>
        :root {
            --primary: #007bff;
            --danger: #ff4d4d;
            --success: #28a745;
            --snooze: #f39c12;
        }

        body {
            font-family: sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }

        .container {
            background: white;
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            text-align: center;
            width: 100%;
            max-width: 450px;
        }

        #clock {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 15px;
            font-family: monospace;
        }

        /* è¨­å®šã‚¨ãƒªã‚¢ */
        .setup-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
        }

        input[type="time"] {
            font-size: 1.5rem;
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
        }

        /* å•é¡Œè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #mathChallenge {
            display: none;
            border-top: 5px solid var(--danger);
            padding-top: 15px;
        }

        #questionBox {
            background: #fff0f0;
            padding: 15px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #d00;
            margin-bottom: 10px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* å›ç­”è¡¨ç¤ºãƒ‘ãƒãƒ« */
        #displayPanel {
            background: #333;
            color: #fff;
            font-size: 1.8rem;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            min-height: 40px;
            word-wrap: break-word;
        }

        /* å…¥åŠ›ç”¨ãƒœã‚¿ãƒ³ãƒ‘ãƒãƒ« */
        .keypad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .keypad button {
            padding: 15px 5px;
            font-size: 1.2rem;
            border: none;
            border-radius: 8px;
            background: #e9ecef;
            cursor: pointer;
            font-weight: bold;
        }

        .keypad button:active { background: #ced4da; }
        .keypad .btn-op { background: #dee2e6; color: var(--primary); }
        .keypad .btn-clear { background: #ffc107; }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .action-btns button {
            border: none;
            padding: 15px;
            font-size: 1.1rem;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
        }

        .btn-set { background: var(--primary); }
        .btn-snooze { background: var(--snooze); }
        .btn-submit { background: var(--success); }

        #snoozeStatus {
            display: none;
            background: #e7f3ff;
            color: var(--primary);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        #trigTable {
            display: none;
            background: #fff9db;
            border: 1px solid #fab005;
            padding: 5px;
            font-size: 0.7rem;
            margin-bottom: 10px;
        }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ccc; padding: 2px; }

        .shake { animation: shake 0.5s infinite; }
        @keyframes shake {
            0%, 100% { transform: translate(0,0); }
            25% { transform: translate(-4px,0); }
            75% { transform: translate(4px,0); }
        }
    </style>
</head>
<body>

<div class="container" id="mainContainer">
    <div id="clock">00:00:00</div>

    <div id="setupArea" class="setup-section">
        <input type="time" id="alarmTime">
        <button class="btn-set" id="setBtn">ã‚¢ãƒ©ãƒ¼ãƒ ã‚’ã‚»ãƒƒãƒˆ</button>
        <p id="alarmStatus" style="font-size: 0.9rem; color: #666; margin-top: 10px;">æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„</p>
    </div>

    <div id="mathChallenge">
        <div id="snoozeStatus">ğŸ•’ é›†ä¸­ã‚¿ã‚¤ãƒ ä¸­... æ®‹ã‚Š <span id="snoozeTimer">180</span>ç§’</div>
        <div id="questionBox">å•é¡Œç”Ÿæˆä¸­...</div>
        
        <div id="trigTable">
            <table style="background: white;">
                <tr><th>Î¸</th><th>0Â°</th><th>30Â°</th><th>45Â°</th><th>60Â°</th><th>90Â°</th></tr>
                <tr><td>sin</td><td>0</td><td>1/2</td><td>1/âˆš2</td><td>âˆš3/2</td><td>1</td></tr>
                <tr><td>cos</td><td>1</td><td>âˆš3/2</td><td>1/âˆš2</td><td>1/2</td><td>0</td></tr>
                <tr><td>tan</td><td>0</td><td>1/âˆš3</td><td>1</td><td>âˆš3</td><td>-</td></tr>
            </table>
        </div>

        <!-- å›ç­”è¡¨ç¤ºãƒ‘ãƒãƒ« -->
        <div id="displayPanel"></div>

        <!-- å…¥åŠ›ãƒ‘ãƒãƒ« -->
        <div class="keypad">
            <button onclick="inputKey('7')">7</button>
            <button onclick="inputKey('8')">8</button>
            <button onclick="inputKey('9')">9</button>
            <button class="btn-clear" onclick="clearKey()">AC</button>
            
            <button onclick="inputKey('4')">4</button>
            <button onclick="inputKey('5')">5</button>
            <button onclick="inputKey('6')">6</button>
            <button class="btn-op" onclick="inputKey('/')">/</button>
            
            <button onclick="inputKey('1')">1</button>
            <button onclick="inputKey('2')">2</button>
            <button onclick="inputKey('3')">3</button>
            <button class="btn-op" onclick="inputKey('âˆš')">âˆš</button>
            
            <button onclick="inputKey('0')">0</button>
            <button class="btn-op" onclick="inputKey('-')">-</button>
            <button class="btn-op" onclick="inputKey('.')">.</button>
            <button class="btn-clear" onclick="deleteKey()">ğŸ”™</button>
        </div>

        <div class="action-btns">
            <button id="snoozeBtn" class="btn-snooze">3åˆ†é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ¶ˆéŸ³ï¼‰</button>
            <button id="submitBtn" class="btn-submit">å›ç­”ã™ã‚‹</button>
        </div>
        <div id="feedback" style="color:red; font-weight:bold; font-size: 0.9rem; height: 1.2rem; margin-bottom: 5px;"></div>
    </div>
</div>

<script>
    let targetTime = null;
    let isRinging = false;
    let isSnoozing = false;
    let correctAnswer = "";
    let audioCtx = null;
    let currentOsc = null;
    let alarmInterval = null;
    let snoozeTimeLeft = 180;
    let snoozeInterval = null;
    let userDisplay = "";

    // æ›´æ–°é˜²æ­¢
    window.addEventListener('beforeunload', (e) => {
        if (isRinging || isSnoozing) { e.preventDefault(); e.returnValue = ''; }
    });

    // æ™‚è¨ˆæ›´æ–°
    function tick() {
        const now = new Date();
        const time = now.toTimeString().split(' ')[0].substring(0, 5);
        document.getElementById('clock').textContent = now.toTimeString().split(' ')[0];
        if (targetTime === time && !isRinging && !isSnoozing) {
            startAlarm();
        }
    }
    setInterval(tick, 1000);

    // ã‚¢ãƒ©ãƒ¼ãƒ ã‚»ãƒƒãƒˆ
    document.getElementById('setBtn').addEventListener('click', () => {
        const val = document.getElementById('alarmTime').value;
        if (val) {
            targetTime = val;
            document.getElementById('alarmStatus').textContent = `ğŸ”” ${val} ã«ã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ`;
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
    });

    // ã‚¢ãƒ©ãƒ¼ãƒ é–‹å§‹
    function startAlarm() {
        isRinging = true;
        isSnoozing = false;
        document.getElementById('setupArea').style.display = 'none';
        document.getElementById('mathChallenge').style.display = 'block';
        document.getElementById('mainContainer').classList.add('shake');
        document.getElementById('snoozeBtn').style.display = 'block';
        document.getElementById('snoozeStatus').style.display = 'none';
        clearKey();
        generateProblem();
        playAlarmSound();
    }

    // éŸ³å†ç”Ÿ
    function playAlarmSound() {
        if (!isRinging) return;
        stopCurrentSound();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(880, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        currentOsc = osc;
        alarmInterval = setTimeout(() => {
            stopCurrentSound();
            if (isRinging) alarmInterval = setTimeout(playAlarmSound, 200);
        }, 300);
    }

    function stopCurrentSound() {
        if (currentOsc) { try { currentOsc.stop(); currentOsc.disconnect(); } catch(e){} currentOsc = null; }
        if (alarmInterval) { clearTimeout(alarmInterval); alarmInterval = null; }
    }

    // ãƒ‘ãƒãƒ«å…¥åŠ›ãƒ­ã‚¸ãƒƒã‚¯
    function inputKey(num) {
        userDisplay += num;
        updateDisplay();
    }
    function clearKey() {
        userDisplay = "";
        updateDisplay();
    }
    function deleteKey() {
        userDisplay = userDisplay.slice(0, -1);
        updateDisplay();
    }
    function updateDisplay() {
        document.getElementById('displayPanel').textContent = userDisplay;
    }

    // ã‚¹ãƒŒãƒ¼ã‚º
    document.getElementById('snoozeBtn').addEventListener('click', () => {
        isRinging = false;
        isSnoozing = true;
        stopCurrentSound();
        document.getElementById('mainContainer').classList.remove('shake');
        document.getElementById('snoozeBtn').style.display = 'none';
        document.getElementById('snoozeStatus').style.display = 'block';
        snoozeTimeLeft = 180;
        document.getElementById('snoozeTimer').textContent = snoozeTimeLeft;
        if (snoozeInterval) clearInterval(snoozeInterval);
        snoozeInterval = setInterval(() => {
            snoozeTimeLeft--;
            document.getElementById('snoozeTimer').textContent = snoozeTimeLeft;
            if (snoozeTimeLeft <= 0) {
                clearInterval(snoozeInterval);
                if (isSnoozing) startAlarm();
            }
        }, 1000);
    });

    // å•é¡Œç”Ÿæˆ
    function generateProblem() {
        const trigTable = document.getElementById('trigTable');
        trigTable.style.display = 'none';
        const type = Math.floor(Math.random() * 5); 
        let q = ""; let a = "";

        switch(type) {
            case 0: // å› æ•°åˆ†è§£
                let v1 = Math.floor(Math.random() * 9) + 1;
                let v2 = Math.floor(Math.random() * 9) + 1;
                q = `xÂ² + ${v1+v2}x + ${v1*v2} = 0 ã®å°ã•ã„æ–¹ã®è§£ã¯ï¼Ÿ`;
                a = `-${Math.max(v1, v2)}`;
                break;
            case 1: // çµ¶å¯¾å€¤
                let v3 = Math.floor(Math.random() * 10) + 10;
                q = `|x - 7| = ${v3} ã®æ­£ã®è§£ã¯ï¼Ÿ`;
                a = `${v3 + 7}`;
                break;
            case 2: // ä¸‰è§’æ¯”
                trigTable.style.display = 'block';
                const list = [{q:"sin 60Â°", a:"âˆš3/2"}, {q:"cos 30Â°", a:"âˆš3/2"}, {q:"tan 30Â°", a:"1/âˆš3"}, {q:"sin 45Â°", a:"1/âˆš2"}];
                const p = list[Math.floor(Math.random()*list.length)];
                q = `${p.q} ã¯ï¼Ÿ`; a = p.a;
                break;
            case 3: // å±•é–‹
                let v4 = Math.floor(Math.random() * 8) + 2;
                q = `(x + ${v4})(x - ${v4}) ã®å®šæ•°é …ã¯ï¼Ÿ`;
                a = `-${v4*v4}`;
                break;
            case 4: // ä¸ç­‰å¼
                let v5 = Math.floor(Math.random() * 3) + 2;
                q = `${v5}x - ${v5*8} < 0 ã‚’æº€ãŸã™æœ€å¤§ã®æ•´æ•°ã¯ï¼Ÿ`;
                a = `7`;
                break;
        }
        document.getElementById('questionBox').innerHTML = q;
        correctAnswer = a;
    }

    // å›ç­”
    document.getElementById('submitBtn').addEventListener('click', () => {
        if (userDisplay === correctAnswer) {
            isRinging = false;
            isSnoozing = false;
            stopCurrentSound();
            if (snoozeInterval) clearInterval(snoozeInterval);
            document.getElementById('mainContainer').classList.remove('shake');
            document.getElementById('mathChallenge').style.display = 'none';
            document.getElementById('setupArea').style.display = 'block';
            targetTime = null;
            document.getElementById('alarmTime').value = "";
            document.getElementById('alarmStatus').textContent = "å®Œå…¨è§£é™¤ï¼ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ï¼";
            alert("æ­£è§£ã§ã™ã€‚");
        } else {
            document.getElementById('feedback').textContent = "ä¸æ­£è§£ï¼å•é¡ŒãŒå¤‰ã‚ã‚Šã¾ã™";
            clearKey();
            generateProblem();
            setTimeout(() => { document.getElementById('feedback').textContent = ""; }, 2000);
        }
    });
</script>

</body>
</html>
