<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜1æ•°å­¦ã‚¢ãƒ©ãƒ¼ãƒ  - ç¶²ç¾…ç‰ˆ</title>
    <style>
        :root {
            --primary: #007bff;
            --danger: #ff4d4d;
            --success: #28a745;
            --snooze: #f39c12;
        }

        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }

        .container {
            background: white;
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            text-align: center;
            width: 100%;
            max-width: 480px;
        }

        #clock {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
        }

        .setup-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
        }

        input[type="time"] {
            font-size: 1.5rem;
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
        }

        #mathChallenge {
            display: none;
            border-top: 5px solid var(--danger);
            padding-top: 15px;
        }

        #questionBox {
            background: #fff0f0;
            padding: 15px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #d00;
            margin-bottom: 10px;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.5;
        }

        #displayPanel {
            background: #333;
            color: #fff;
            font-size: 2rem;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            min-height: 45px;
            font-family: monospace;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .keypad button {
            padding: 15px 5px;
            font-size: 1.2rem;
            border: none;
            border-radius: 8px;
            background: #e9ecef;
            cursor: pointer;
            font-weight: bold;
        }

        .keypad .btn-op { background: #dee2e6; color: var(--primary); }
        .keypad .btn-clear { background: #ffc107; }

        .action-btns button {
            border: none;
            padding: 15px;
            font-size: 1.1rem;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
        }

        .btn-set { background: var(--primary); }
        .btn-snooze { background: var(--snooze); }
        .btn-submit { background: var(--success); }

        #trigTable {
            display: none;
            background: #fff9db;
            border: 1px solid #fab005;
            padding: 5px;
            font-size: 0.7rem;
            margin-bottom: 10px;
        }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ccc; padding: 2px; }

        .shake { animation: shake 0.5s infinite; }
        @keyframes shake {
            0%, 100% { transform: translate(0,0); }
            25% { transform: translate(-4px,0); }
            75% { transform: translate(4px,0); }
        }
    </style>
</head>
<body>

<div class="container" id="mainContainer">
    <div id="clock">00:00:00</div>

    <div id="setupArea" class="setup-section">
        <input type="time" id="alarmTime">
        <button class="btn-set" id="setBtn">ã‚¢ãƒ©ãƒ¼ãƒ ã‚’ã‚»ãƒƒãƒˆ</button>
        <p id="alarmStatus" style="font-size: 0.8rem; color: #666; margin-top: 10px;">æ™‚é–“ã‚’æŒ‡å®šã—ã¦ã€Œã‚»ãƒƒãƒˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
    </div>

    <div id="mathChallenge">
        <div id="snoozeStatus" style="display:none; color:var(--snooze); font-weight:bold; margin-bottom:10px;">
            ğŸ•’ é›†ä¸­ã‚¹ãƒŒãƒ¼ã‚ºä¸­... æ®‹ã‚Š <span id="snoozeTimer">180</span>ç§’
        </div>
        <div id="questionBox">å•é¡Œç”Ÿæˆä¸­...</div>
        
        <div id="trigTable">
            <table>
                <tr><th>Î¸</th><th>0Â°</th><th>30Â°</th><th>45Â°</th><th>60Â°</th><th>90Â°</th><th>120Â°</th><th>135Â°</th><th>150Â°</th></tr>
                <tr><td>sin</td><td>0</td><td>1/2</td><td>1/âˆš2</td><td>âˆš3/2</td><td>1</td><td>âˆš3/2</td><td>1/âˆš2</td><td>1/2</td></tr>
                <tr><td>cos</td><td>1</td><td>âˆš3/2</td><td>1/âˆš2</td><td>1/2</td><td>0</td><td>-1/2</td><td>-1/âˆš2</td><td>-âˆš3/2</td></tr>
            </table>
        </div>

        <div id="displayPanel"></div>

        <div class="keypad">
            <button onclick="inputKey('7')">7</button>
            <button onclick="inputKey('8')">8</button>
            <button onclick="inputKey('9')">9</button>
            <button class="btn-clear" onclick="clearKey()">AC</button>
            
            <button onclick="inputKey('4')">4</button>
            <button onclick="inputKey('5')">5</button>
            <button onclick="inputKey('6')">6</button>
            <button class="btn-op" onclick="inputKey('/')">/</button>
            
            <button onclick="inputKey('1')">1</button>
            <button onclick="inputKey('2')">2</button>
            <button onclick="inputKey('3')">3</button>
            <button class="btn-op" onclick="inputKey('âˆš')">âˆš</button>
            
            <button onclick="inputKey('0')">0</button>
            <button class="btn-op" onclick="inputKey('-')">-</button>
            <button class="btn-op" onclick="inputKey('.')">.</button>
            <button class="btn-clear" onclick="deleteKey()">ğŸ”™</button>
        </div>

        <div class="action-btns">
            <button id="snoozeBtn" class="btn-snooze">3åˆ†é›†ä¸­ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ¶ˆéŸ³ï¼‰</button>
            <button id="submitBtn" class="btn-submit">å›ç­”ã™ã‚‹</button>
        </div>
        <div id="feedback" style="color:red; font-weight:bold; font-size: 0.9rem; min-height: 1.2rem;"></div>
    </div>
</div>

<script>
    let targetTime = null;
    let isRinging = false;
    let isSnoozing = false;
    let correctAnswer = "";
    let audioCtx = null;
    let currentOsc = null;
    let alarmInterval = null;
    let snoozeTimeLeft = 180;
    let snoozeInterval = null;
    let userDisplay = "";

    // æ›´æ–°é˜²æ­¢
    window.addEventListener('beforeunload', (e) => {
        if (isRinging || isSnoozing) { e.preventDefault(); e.returnValue = ''; }
    });

    // æ™‚è¨ˆæ›´æ–°
    function tick() {
        const now = new Date();
        const time = now.toTimeString().split(' ')[0].substring(0, 5);
        document.getElementById('clock').textContent = now.toTimeString().split(' ')[0];
        if (targetTime === time && !isRinging && !isSnoozing) startAlarm();
    }
    setInterval(tick, 1000);

    document.getElementById('setBtn').addEventListener('click', () => {
        const val = document.getElementById('alarmTime').value;
        if (val) {
            targetTime = val;
            document.getElementById('alarmStatus').textContent = `ğŸ”” ${val} ã«ã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ`;
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
    });

    function startAlarm() {
        isRinging = true;
        isSnoozing = false;
        document.getElementById('setupArea').style.display = 'none';
        document.getElementById('mathChallenge').style.display = 'block';
        document.getElementById('mainContainer').classList.add('shake');
        document.getElementById('snoozeBtn').style.display = 'block';
        document.getElementById('snoozeStatus').style.display = 'none';
        clearKey();
        generateProblem();
        playAlarmSound();
    }

    function playAlarmSound() {
        if (!isRinging) return;
        stopCurrentSound();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(880, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        currentOsc = osc;
        alarmInterval = setTimeout(() => {
            stopCurrentSound();
            if (isRinging) alarmInterval = setTimeout(playAlarmSound, 200);
        }, 300);
    }

    function stopCurrentSound() {
        if (currentOsc) { try { currentOsc.stop(); currentOsc.disconnect(); } catch(e){} currentOsc = null; }
        if (alarmInterval) { clearTimeout(alarmInterval); alarmInterval = null; }
    }

    function inputKey(num) { userDisplay += num; updateDisplay(); }
    function clearKey() { userDisplay = ""; updateDisplay(); }
    function deleteKey() { userDisplay = userDisplay.slice(0, -1); updateDisplay(); }
    function updateDisplay() { document.getElementById('displayPanel').textContent = userDisplay; }

    document.getElementById('snoozeBtn').addEventListener('click', () => {
        isRinging = false; isSnoozing = true;
        stopCurrentSound();
        document.getElementById('mainContainer').classList.remove('shake');
        document.getElementById('snoozeBtn').style.display = 'none';
        document.getElementById('snoozeStatus').style.display = 'block';
        snoozeTimeLeft = 180;
        document.getElementById('snoozeTimer').textContent = snoozeTimeLeft;
        if (snoozeInterval) clearInterval(snoozeInterval);
        snoozeInterval = setInterval(() => {
            snoozeTimeLeft--;
            document.getElementById('snoozeTimer').textContent = snoozeTimeLeft;
            if (snoozeTimeLeft <= 0) { clearInterval(snoozeInterval); if (isSnoozing) startAlarm(); }
        }, 1000);
    });

    // --- å•é¡Œç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³æ‹¡å¤§ï¼‰ ---
    function generateProblem() {
        const trigTable = document.getElementById('trigTable');
        trigTable.style.display = 'none';
        const types = 12; // å•é¡Œãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ•°
        const type = Math.floor(Math.random() * types); 
        let q = ""; let a = "";

        switch(type) {
            case 0: // å› æ•°åˆ†è§£ (æ•°I)
                let v1 = rand(2, 9); let v2 = rand(2, 9);
                q = `xÂ² + ${v1+v2}x + ${v1*v2} = 0<br>ã®è² ã®è§£ã®ã†ã¡ã€å°ã•ã„æ–¹ã¯ï¼Ÿ`;
                a = `-${Math.max(v1, v2)}`;
                break;
            case 1: // çµ¶å¯¾å€¤ (æ•°I)
                let v3 = rand(10, 30);
                q = `|x - 8| = ${v3}<br>ã®æ­£ã®è§£ã¯ï¼Ÿ`;
                a = `${v3 + 8}`;
                break;
            case 2: // ä¸‰è§’æ¯” (æ•°I)
                trigTable.style.display = 'block';
                const list = [
                    {q:"sin 120Â°", a:"âˆš3/2"}, {q:"cos 135Â°", a:"-1/âˆš2"}, 
                    {q:"sin 150Â°", a:"1/2"}, {q:"cos 120Â°", a:"-1/2"},
                    {q:"tan 45Â°", a:"1"}, {q:"sin 90Â°", a:"1"}
                ];
                const p = list[Math.floor(Math.random()*list.length)];
                q = `${p.q} ã®å€¤ã¯ï¼Ÿ`; a = p.a;
                break;
            case 3: // 2æ¬¡é–¢æ•°ã®é ‚ç‚¹ (æ•°I)
                let p_val = rand(1, 9); let q_val = rand(1, 9);
                q = `y = (x - ${p_val})Â² + ${q_val}<br>ã®é ‚ç‚¹ã®yåº§æ¨™ã¯ï¼Ÿ`;
                a = `${q_val}`;
                break;
            case 4: // é›†åˆ (æ•°A)
                let nA = rand(15, 30); let nB = rand(10, 20); let nCap = rand(5, 9);
                q = `n(A)=${nA}, n(B)=${nB}, n(Aâˆ©B)=${nCap}<br>ã®ã¨ãã€n(AâˆªB) ã¯ï¼Ÿ`;
                a = `${nA + nB - nCap}`;
                break;
            case 5: // é †åˆ— P (æ•°A)
                let nP = rand(4, 6);
                q = `â‚…P${nP-2} ã®å€¤ã¯ï¼Ÿ`;
                a = `${calcP(5, nP-2)}`;
                break;
            case 6: // çµ„åˆã› C (æ•°A)
                let nC = rand(3, 5);
                q = `â‚†C${nC} ã®å€¤ã¯ï¼Ÿ`;
                a = `${calcC(6, nC)}`;
                break;
            case 7: // ç¢ºç‡ (æ•°A)
                q = `1å€‹ã®ã‚µã‚¤ã‚³ãƒ­ã‚’æŠ•ã’ã‚‹ã¨ãã€<br>å¶æ•°ã®ç›®ãŒå‡ºã‚‹ç¢ºç‡ã¯ï¼Ÿ (åˆ†æ•°ã§)`;
                a = `1/2`;
                break;
            case 8: // å±•é–‹ (æ•°I)
                let v8 = rand(3, 10);
                q = `(x + ${v8})Â² ã‚’å±•é–‹ã—ãŸã¨ãã®<br>å®šæ•°é …ã¯ï¼Ÿ`;
                a = `${v8*v8}`;
                break;
            case 9: // 1æ¬¡ä¸ç­‰å¼ (æ•°I)
                let v9 = rand(2, 5);
                q = `${v9}x - ${v9*7} < 0<br>ã‚’æº€ãŸã™æœ€å¤§ã®æ•´æ•°ã¯ï¼Ÿ`;
                a = `6`;
                break;
            case 10: // é€²æ•°å¤‰æ› (æ•°A)
                let dec = rand(5, 15);
                q = `10é€²æ•°ã® ${dec} ã‚’<br>2é€²æ³•ã§è¡¨ã™ã¨ï¼Ÿ`;
                a = dec.toString(2);
                break;
            case 11: // ä¸‰è§’å½¢ã®é¢ç© (æ•°I)
                q = `b=4, c=6, A=30Â° ã®ã¨ã<br>â–³ABCã®é¢ç©ã¯ï¼Ÿ`;
                a = `6`; // 1/2 * 4 * 6 * 1/2
                break;
        }
        document.getElementById('questionBox').innerHTML = q;
        correctAnswer = a;
    }

    function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
    function calcP(n, r) { let res = 1; for(let i=0; i<r; i++) res *= (n-i); return res; }
    function calcC(n, r) { if(r>n/2) r = n-r; return calcP(n,r) / calcP(r,r); }

    document.getElementById('submitBtn').addEventListener('click', () => {
        if (userDisplay === correctAnswer) {
            isRinging = false; isSnoozing = false;
            stopCurrentSound();
            if (snoozeInterval) clearInterval(snoozeInterval);
            document.getElementById('mainContainer').classList.remove('shake');
            document.getElementById('mathChallenge').style.display = 'none';
            document.getElementById('setupArea').style.display = 'block';
            targetTime = null;
            document.getElementById('alarmTime').value = "";
            document.getElementById('alarmStatus').textContent = "è§£é™¤æˆåŠŸï¼ç›®ãŒè¦šã‚ã¾ã—ãŸã‹ï¼Ÿ";
            alert("æ­£è§£ã§ã™ã€‚ã‚¢ãƒ©ãƒ¼ãƒ ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚");
        } else {
            document.getElementById('feedback').textContent = "ä¸æ­£è§£ï¼å•é¡Œå†ç”Ÿæˆ";
            clearKey(); generateProblem();
            setTimeout(() => { document.getElementById('feedback').textContent = ""; }, 1500);
        }
    });
</script>

</body>
</html>
